name: ğŸš€ Deploy Lambda

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  # âš¡ CONFIGURE ESTAS VARIÃVEIS PARA CADA REPOSITÃ“RIO
  LAMBDA_NAME: "chatbot-agendamento-twilio"  # âš ï¸ MUDE PARA CADA LAMBDA!
  AWS_REGION: "us-east-2"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Validar cÃ³digo
        run: |
          echo "ğŸ§ª Validando cÃ³digo Lambda..."
          
          # Verifica se tem arquivo principal
          if [ ! -f "index.mjs" ] && [ ! -f "index.js" ]; then
            echo "âŒ ERRO: Nenhum index.mjs ou index.js encontrado!"
            ls -la
            exit 1
          fi
          
          # Detecta tipo de mÃ³dulo
          if [ -f "index.mjs" ]; then
            echo "âœ… ES Modules (index.mjs)"
            CODE_FILE="index.mjs"
            if ! grep -q "export const handler" index.mjs; then
              echo "âš ï¸ AVISO: 'export const handler' nÃ£o encontrado em index.mjs"
            fi
          else
            echo "âœ… CommonJS (index.js)"
            CODE_FILE="index.js"
            if ! grep -q "exports.handler" index.js; then
              echo "âš ï¸ AVISO: 'exports.handler' nÃ£o encontrado em index.js"
            fi
          fi
          
          echo "ğŸ“„ Arquivo: $CODE_FILE"
          echo "ğŸ“ Tamanho: $(stat -f%z "$CODE_FILE") bytes"

      - name: ğŸ“¦ Criar pacote LIMPO
        run: |
          echo "ğŸ—œï¸ Criando package..."
          
          # âš¡ ZIP APENAS o arquivo necessÃ¡rio
          zip lambda-package.zip "$CODE_FILE"
          
          echo "ğŸ” ConteÃºdo do package:"
          unzip -l lambda-package.zip
          echo "ğŸ“Š Tamanho: $(stat -f%z lambda-package.zip) bytes"

      - name: ğŸ” Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: âœ… Verificar Lambda existente
        run: |
          echo "ğŸ” Verificando Lambda: ${{ env.LAMBDA_NAME }}"
          
          if aws lambda get-function \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Configuration.Runtime' \
            --output text 2>/dev/null; then
            
            echo "âœ… Lambda encontrada!"
            echo "ğŸ”„ Runtime atual: $(aws lambda get-function --function-name "${{ env.LAMBDA_NAME }}" --query 'Configuration.Runtime' --output text)"
          else
            echo "âŒ Lambda '${{ env.LAMBDA_NAME }}' nÃ£o encontrada!"
            echo ""
            echo "ğŸ“‹ Crie a Lambda manualmente primeiro:"
            echo "1. VÃ¡ para AWS Console â†’ Lambda"
            echo "2. Create function: ${{ env.LAMBDA_NAME }}"
            echo "3. Runtime: Node.js 20.x"
            echo "4. Handler: index.handler"
            echo "5. Memory: 128MB, Timeout: 30s"
            exit 1
          fi

      - name: ğŸš€ Fazer Deploy
        run: |
          echo "ğŸš€ Deploy para: ${{ env.LAMBDA_NAME }}"
          
          # Deploy seguro
          aws lambda update-function-code \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --zip-file fileb://lambda-package.zip \
            --region "${{ env.AWS_REGION }}"
          
          echo "âœ… CÃ³digo atualizado!"
          
          # Mostra Ãºltima modificaÃ§Ã£o
          echo "ğŸ•’ Ãšltima atualizaÃ§Ã£o:"
          aws lambda get-function \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --query 'Configuration.LastModified' \
            --region "${{ env.AWS_REGION }}"

      - name: ğŸ§ª Teste rÃ¡pido (opcional)
        run: |
          echo "ğŸ§ª Testando Lambda..."
          sleep 5  # Aguarda atualizaÃ§Ã£o
          
          # Teste simples
          aws lambda invoke \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --payload '{}' \
            --cli-binary-format raw-in-base64-out \
            --region "${{ env.AWS_REGION }}" \
            test-output.json 2>&1 || echo "Teste falhou (pode ser normal)"
          
          if [ -f "test-output.json" ]; then
            echo "ğŸ“„ SaÃ­da:"
            cat test-output.json
            rm test-output.json
          fi

      - name: ğŸ“ Notificar sucesso
        if: success()
        run: |
          echo "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
          echo "Lambda: ${{ env.LAMBDA_NAME }}"
          echo "RepositÃ³rio: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"